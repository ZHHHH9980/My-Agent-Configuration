<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>News Aggregator</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 800px; margin: 40px auto; padding: 0 20px; }
        h1 { margin-bottom: 20px; color: #333; }
        .filters { margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; border: 1px solid #ddd; }
        .filter-group { margin-bottom: 10px; }
        .filter-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .filter-select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
        .refresh-section { margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .refresh-button { 
          background: #1428a0; 
          color: white; 
          border: none; 
          padding: 8px 16px; 
          border-radius: 4px; 
          cursor: pointer; 
          font-size: 14px;
          font-weight: 500;
        }
        .refresh-button:hover { background: #0d1c6b; }
        .refresh-button:disabled { 
          background: #ccc; 
          cursor: not-allowed; 
          opacity: 0.7; 
        }
        .refresh-status { 
          margin-top: 8px; 
          font-size: 12px; 
          color: #666; 
          display: flex;
          align-items: center;
          gap: 5px;
        }
        .refresh-status.loading { color: #1428a0; }
        .refresh-status.success { color: #006600; }
        .refresh-status.error { color: #d00; }
        .cache-info { 
          font-size: 11px; 
          color: #888; 
          margin-top: 5px;
          font-style: italic;
        }
        .article { padding: 20px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; background: white; }
        .article h3 { margin-bottom: 10px; }
        .article a { color: #0066cc; text-decoration: none; }
        .article a:hover { text-decoration: underline; }
        .meta { font-size: 14px; color: #666; margin-top: 10px; }
        .score { font-weight: bold; color: #006600; }
        .source { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 500; margin-right: 8px; }
        .source-hackernews { background: #ff6600; color: white; }
        .source-bloomberg { background: #1428a0; color: white; }
        .source-wsj { background: #006400; color: white; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { color: #d00; padding: 10px; background: #ffe6e6; border-radius: 4px; margin: 10px 0; }
    </style>
</head>
<body>
     <div class="container">
        <h1>ðŸ“° News Aggregator</h1>
        
        <div class="filters">
            <div class="filter-group">
                <label for="sourceFilter">Filter by Source:</label>
                 <select id="sourceFilter" class="filter-select">
                    <option value="all">All Sources</option>
                    <option value="hackernews">Hacker News (Technology)</option>
                    <option value="bloomberg">Bloomberg (Financial)</option>
                    <option value="wsj">Wall Street Journal (Business)</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="sortFilter">Sort by:</label>
                <select id="sortFilter" class="filter-select">
                    <option value="trending">Trending Score</option>
                    <option value="newest">Newest First</option>
                </select>
            </div>
            
            <div class="refresh-section" id="bloombergRefreshSection" style="display: none;">
                <button id="refreshBloombergBtn" class="refresh-button">
                    ðŸ”„ Refresh Bloomberg News
                </button>
                <button id="proxyBloombergBtn" class="refresh-button" style="background: #1428a0; margin-left: 10px;">
                    ðŸ“‹ Copy Bookmarklet Code
                </button>
                <div class="refresh-status" id="refreshBloombergStatus"></div>
                <div class="cache-info" id="bloombergCacheInfo"></div>
            </div>
            
            <div class="refresh-section" id="wsjRefreshSection" style="display: none;">
                <button id="refreshWSJBtn" class="refresh-button">
                    ðŸ“° Refresh Wall Street Journal News
                </button>
                <button id="proxyWSJBtn" class="refresh-button" style="background: #006400; margin-left: 10px;">
                    ðŸ“‹ Copy Bookmarklet Code
                </button>
                <div class="refresh-status" id="refreshWSJStatus"></div>
                <div class="cache-info" id="wsjCacheInfo"></div>
            </div>
            
            <div class="bookmarklet-section" style="margin-top: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px; border: 1px solid #b3d9ff; display: none;" id="bookmarkletSection">
                <h3 style="margin-bottom: 10px; color: #28a745;">âœ… Two Simple Options</h3>
                <p style="margin-bottom: 15px; font-size: 14px;">
                    Choose whichever works best for you. Both bypass bot detection.
                </p>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border-radius: 6px; border: 1px solid #28a745;">
                    <h4 style="margin-bottom: 8px; color: #28a745;">ðŸš€ Option 1: Console Testing (Easiest)</h4>
                    <p style="font-size: 14px; margin-bottom: 10px;">
                        <strong>No setup needed - just copy/paste in console</strong><br>
                        1. <button onclick="copyAutoBookmarkletForConsole()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin: 5px; font-weight: bold;">Copy Console Code</button><br>
                        2. Open <a href="https://www.bloomberg.com" target="_blank" style="color: #1428a0; font-weight: bold;">Bloomberg.com</a><br>
                        3. Press <strong>F12</strong> â†’ <strong>Console</strong> tab<br>
                        4. <strong>Paste</strong> code â†’ Press <strong>Enter</strong><br>
                        5. Articles appear here instantly!<br>
                        <small style="color: #666;">Repeat whenever you want fresh articles</small>
                    </p>
                </div>
                
                <div style="margin-bottom: 20px; padding: 15px; background: #fff3cd; border-radius: 6px; border: 1px solid #ffc107;">
                    <h4 style="margin-bottom: 8px; color: #d48806;">ðŸ“Œ Option 2: One-Line Bookmarklet (For Convenience)</h4>
                    <p style="font-size: 14px; margin-bottom: 10px;">
                        <strong>Create once, use forever</strong><br>
                        1. <button onclick="copyOneLineBookmarklet()" style="background: #ffc107; color: #000; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin: 5px; font-weight: bold;">Copy Bookmarklet Code</button><br>
                        2. <strong>Right-click bookmarks bar</strong> â†’ <strong>"Add page..."</strong><br>
                        3. <strong>Name:</strong> "News Aggregator"<br>
                        4. <strong>URL:</strong> Paste the code<br>
                        5. <strong>Save</strong><br>
                        6. Visit Bloomberg/WSJ â†’ Click bookmark â†’ Done!<br>
                        <small style="color: #666;">Works on both Bloomberg and WSJ</small>
                    </p>
                </div>
                
                <div id="bookmarkletStatus" style="margin-top: 10px; font-size: 12px; color: #666;"></div>
                

                
                <div style="margin-top: 15px; padding: 10px; background: #f0f0f0; border-radius: 4px; border-left: 4px solid #0066cc;">
                    <strong>API Test:</strong> 
                    <button onclick="testBookmarkletAPI()" style="background: #0066cc; color: white; border: none; padding: 3px 8px; border-radius: 3px; cursor: pointer; font-size: 12px; margin-left: 5px;">
                        Test Bookmarklet API
                    </button>
                    <span id="testStatus" style="margin-left: 10px; font-size: 11px;"></span>
                </div>
            </div>
        </div>

        <div id="articles">
            <div class="loading">Loading articles...</div>
        </div>
    </div>

    <script>
        let currentSource = 'all';
        let currentSort = 'trending';
        let isRefreshing = false;

        async function fetchArticles(forceRefresh = false) {
            const articlesContainer = document.getElementById('articles');
            articlesContainer.innerHTML = '<div class="loading">Loading articles...</div>';

            try {
                let url = '/api/articles?limit=15';
                if (currentSource !== 'all') {
                    url += `&source=${currentSource}`;
                }
                 if (forceRefresh && (currentSource === 'bloomberg' || currentSource === 'wsj')) {
                    url += '&refresh=true';
                }

                const response = await fetch(url);
                const articles = await response.json();

                // Sort if needed
                let sortedArticles = [...articles];
                if (currentSort === 'newest') {
                    sortedArticles.sort((a, b) => b.time - a.time);
                }

                displayArticles(sortedArticles);
                updateCacheInfo();
            } catch (error) {
                console.error('Error fetching articles:', error);
                articlesContainer.innerHTML = `
                    <div class="error">
                        Error loading articles. Please try again.
                        <br><small>${error.message}</small>
                    </div>
                `;
            }
        }

        async function refreshBloombergNews() {
            if (isRefreshing) return;
            
            const refreshBtn = document.getElementById('refreshBloombergBtn');
            const statusEl = document.getElementById('refreshBloombergStatus');
            
            isRefreshing = true;
            refreshBtn.disabled = true;
            statusEl.textContent = 'Refreshing Bloomberg news...';
            statusEl.className = 'refresh-status loading';
            
            try {
                const response = await fetch('/api/refresh/bloomberg', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    statusEl.textContent = `âœ… ${result.message}`;
                    statusEl.className = 'refresh-status success';
                    
                    // Refresh the articles display
                    await fetchArticles();
                    
                    // Clear success message after 3 seconds
                    setTimeout(() => {
                        statusEl.textContent = '';
                        statusEl.className = 'refresh-status';
                    }, 3000);
                } else {
                    statusEl.textContent = `âŒ ${result.error}`;
                    statusEl.className = 'refresh-status error';
                }
            } catch (error) {
                statusEl.textContent = `âŒ Error: ${error.message}`;
                statusEl.className = 'refresh-status error';
            } finally {
                isRefreshing = false;
                refreshBtn.disabled = false;
                updateCacheInfo();
            }
        }

        async function refreshWSJNews() {
            if (isRefreshing) return;
            
            const refreshBtn = document.getElementById('refreshWSJBtn');
            const statusEl = document.getElementById('refreshWSJStatus');
            
            isRefreshing = true;
            refreshBtn.disabled = true;
            statusEl.textContent = 'Refreshing Wall Street Journal news...';
            statusEl.className = 'refresh-status loading';
            
            try {
                const response = await fetch('/api/refresh/wsj', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    statusEl.textContent = `âœ… ${result.message}`;
                    statusEl.className = 'refresh-status success';
                    
                    // Refresh the articles display
                    await fetchArticles();
                    
                    // Clear success message after 3 seconds
                    setTimeout(() => {
                        statusEl.textContent = '';
                        statusEl.className = 'refresh-status';
                    }, 3000);
                } else {
                    statusEl.textContent = `âŒ ${result.error}`;
                    statusEl.className = 'refresh-status error';
                }
            } catch (error) {
                statusEl.textContent = `âŒ Error: ${error.message}`;
                statusEl.className = 'refresh-status error';
            } finally {
                isRefreshing = false;
                refreshBtn.disabled = false;
                updateCacheInfo();
            }
        }



        // Helper function to update cache with new articles
        async function updateCacheWithArticles(newArticles, source) {
            try {
                // Get current cache
                const response = await fetch('/api/articles?limit=50');
                const currentArticles = await response.json();
                
                // Filter out old articles from same source
                const otherArticles = currentArticles.filter(a => a.source !== source);
                
                // Combine with new articles
                const updatedArticles = [...newArticles, ...otherArticles]
                    .sort((a, b) => b.time - a.time)
                    .slice(0, 50);
                
                // In a real app, we'd update the server cache
                // For now, we'll just update the local display
                console.log(`Updated ${source} cache with ${newArticles.length} new articles`);
                
            } catch (error) {
                console.error('Error updating cache:', error);
            }
        }

        async function updateCacheInfo() {
            try {
                const response = await fetch('/api/cache/status');
                const status = await response.json();
                
                // Update Bloomberg cache info
                const bloombergCacheInfo = document.getElementById('bloombergCacheInfo');
                if (currentSource === 'bloomberg' || currentSource === 'all') {
                    if (status.cacheValid) {
                        bloombergCacheInfo.textContent = `ðŸ“¦ Bloomberg: Using cached data (expires in ${status.expiresIn})`;
                    } else if (status.hasCache) {
                        bloombergCacheInfo.textContent = 'ðŸ“¦ Bloomberg: Cache expired - refresh for latest news';
                    } else {
                        bloombergCacheInfo.textContent = 'ðŸ“¦ Bloomberg: No cache - refresh to load news';
                    }
                } else {
                    bloombergCacheInfo.textContent = '';
                }
                
                // Update WSJ cache info
                const wsjCacheInfo = document.getElementById('wsjCacheInfo');
                if (currentSource === 'wsj' || currentSource === 'all') {
                    if (status.cacheValid) {
                        wsjCacheInfo.textContent = `ðŸ“° WSJ: Using cached data (expires in ${status.expiresIn})`;
                    } else if (status.hasCache) {
                        wsjCacheInfo.textContent = 'ðŸ“° WSJ: Cache expired - refresh for latest news';
                    } else {
                        wsjCacheInfo.textContent = 'ðŸ“° WSJ: No cache - refresh to load news';
                    }
                } else {
                    wsjCacheInfo.textContent = '';
                }
            } catch (error) {
                console.error('Error fetching cache status:', error);
            }
        }

        function displayArticles(articles) {
            const container = document.getElementById('articles');
            
            if (articles.length === 0) {
                container.innerHTML = '<div class="loading">No articles found.</div>';
                return;
            }

            container.innerHTML = articles.map(article => `
                <div class="article">
                    <h3><a href="${article.url}" target="_blank">${article.title}</a></h3>
                    ${article.description ? `<p style="margin: 10px 0; color: #444; font-size: 14px;">${article.description}</p>` : ''}
                    <div class="meta">
                        <span class="source source-${article.source}">${article.source}</span>
                        <span class="score">Score: ${Math.round(article.trendingScore || article.score || 0)}</span> |
                        ${article.by ? `By: ${article.by} | ` : ''}
                        ${article.descendants ? `Comments: ${article.descendants} | ` : ''}
                        ${article.time ? `Posted: ${formatTime(article.time)}` : ''}
                    </div>
                </div>
            `).join('');
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp * 1000);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);

            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }

        // Show/hide refresh sections
        function updateRefreshSection() {
            const bloombergSection = document.getElementById('bloombergRefreshSection');
            const wsjSection = document.getElementById('wsjRefreshSection');
            const bookmarkletSection = document.getElementById('bookmarkletSection');
            
            bloombergSection.style.display = (currentSource === 'bloomberg' || currentSource === 'all') ? 'block' : 'none';
            wsjSection.style.display = (currentSource === 'wsj' || currentSource === 'all') ? 'block' : 'none';
            bookmarkletSection.style.display = (currentSource === 'bloomberg' || currentSource === 'wsj' || currentSource === 'all') ? 'block' : 'none';
        }

        // Event listeners for filters
        document.getElementById('sourceFilter').addEventListener('change', (e) => {
            currentSource = e.target.value;
            updateRefreshSection();
            fetchArticles();
        });

        document.getElementById('sortFilter').addEventListener('change', (e) => {
            currentSort = e.target.value;
            fetchArticles();
        });

        // Refresh buttons
        document.getElementById('refreshBloombergBtn').addEventListener('click', refreshBloombergNews);
        document.getElementById('refreshWSJBtn').addEventListener('click', refreshWSJNews);
        // These buttons now use the one-line bookmarklet
        document.getElementById('proxyBloombergBtn').addEventListener('click', copyOneLineBookmarklet);
        document.getElementById('proxyWSJBtn').addEventListener('click', copyOneLineBookmarklet);

        // Bookmarklet copy functions (only 2 options)
        async function copyOneLineBookmarklet() {
            try {
                const response = await fetch('/bookmarklets/one-line-bloomberg.js');
                const code = await response.text();
                await navigator.clipboard.writeText(code);
                showBookmarkletStatus('âœ… Bookmarklet code copied! Create bookmark with this URL.');
            } catch (error) {
                console.error('Error copying bookmarklet:', error);
                showBookmarkletStatus('âŒ Error copying code. Check console for details.');
            }
        }
        
        async function copyAutoBookmarkletForConsole() {
            try {
                const response = await fetch('/bookmarklets/console-test.js');
                const code = await response.text();
                await navigator.clipboard.writeText(code);
                showBookmarkletStatus('âœ… Console code copied! Paste in Bloomberg.com console (F12 â†’ Console)');
            } catch (error) {
                console.error('Error copying console code:', error);
                showBookmarkletStatus('âŒ Error copying code. Check console for details.');
            }
        }
        
        function showBookmarkletStatus(message) {
            const statusEl = document.getElementById('bookmarkletStatus');
            statusEl.textContent = message;
            statusEl.style.color = message.startsWith('âœ…') ? '#006600' : '#cc0000';
            setTimeout(() => { statusEl.textContent = ''; }, 5000);
        }
        
        // Test bookmarklet API
        async function testBookmarkletAPI() {
            const statusEl = document.getElementById('testStatus');
            statusEl.textContent = 'Testing...';
            statusEl.style.color = '#0066cc';
            
            try {
                const response = await fetch('/api/bookmarklet', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        articles: [{
                            title: 'Test Article from Bookmarklet',
                            url: 'https://example.com/test',
                            source: 'bloomberg'
                        }],
                        source: 'bloomberg',
                        url: 'https://www.bloomberg.com'
                    })
                });
                
                const result = await response.json();
                if (response.ok) {
                    statusEl.textContent = 'âœ… API working! Test article added.';
                    statusEl.style.color = '#006600';
                    // Refresh to show test article
                    setTimeout(() => fetchArticles(), 1000);
                } else {
                    statusEl.textContent = 'âŒ API error: ' + (result.error || 'Unknown error');
                    statusEl.style.color = '#cc0000';
                }
            } catch (error) {
                statusEl.textContent = 'âŒ Network error: ' + error.message;
                statusEl.style.color = '#cc0000';
            }
            
            setTimeout(() => {
                statusEl.textContent = '';
            }, 5000);
        }
        
        // Initial load
        updateRefreshSection();
        fetchArticles();
        // No more automatic polling - manual refresh only
    </script>
</body>
</html>